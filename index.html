import React, { useState } from 'react';
import { RenderSettings, HDRI_ENVIRONMENTS, ASPECT_RATIOS } from './constants';
import { generateArchitectureRender } from './services/gemini';

export default function AvantgardApp() {
  // ุงูุญุงูุงุช (States) - ุงูุญูุงุธ ุนูู ูู ุงูุฎุตุงุฆุต
  const [sourceImage, setSourceImage] = useState<string | null>(null);
  const [renderedImage, setRenderedImage] = useState<string | null>(null);
  const [isRendering, setIsRendering] = useState(false);
  
  // ุฅุนุฏุงุฏุงุช ุงูุฑูุฏุฑ (ุงูุชู ุชุธูุฑ ูู ุงููููู)
  const [settings, setSettings] = useState<RenderSettings>({
    prompt: '', // ูุงูุฐุฉ ุฃูุงูุฑ ุงูุฐูุงุก ุงูุงุตุทูุงุนู ุงูุฌุฏูุฏุฉ
    hdri: 'urban',
    aspectRatio: '1:1',
    consistency: 85,
    creativity: 70,
    quality: 'ultra'
  });

  const handleFileUpload = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (en) => setSourceImage(en.target?.result as string);
      reader.readAsDataURL(file);
    }
  };

  const startRender = async () => {
    if (!sourceImage) return alert("ูุฑุฌู ุฑูุน ุงููุดุฑูุน ุฃููุงู");
    setIsRendering(true);
    try {
      // ููุง ูุชู ุฅุฑุณุงู ุงูุตูุฑุฉ + ุฃูุถุงุน ุงูุฅุถุงุกุฉ + ุฃูุงูุฑ ุงูุฐูุงุก ุงูุงุตุทูุงุนู
      const result = await generateArchitectureRender(sourceImage, settings);
      setRenderedImage(result);
    } catch (error) {
      console.error(error);
    } finally {
      setIsRendering(false);
    }
  };

  return (
    <div className="flex h-screen bg-[#05070a] text-gray-300 dir-rtl" dir="rtl">
      
      {/* 1. ุงูุดุฑูุท ุงูุฌุงูุจู ุงูุฃููู: ุงูุฎุตุงุฆุต ูุฃูุงูุฑ ุงูุฐูุงุก ุงูุงุตุทูุงุนู */}
      <aside className="w-[380px] border-l border-gray-800 bg-[#0d1117] p-6 flex flex-col gap-6 overflow-y-auto">
        <div className="text-center pb-4 border-b border-gray-800">
          <h1 className="text-2xl font-black text-white italic tracking-tighter">AVANTGARD AI</h1>
          <p className="text-[9px] text-blue-500 font-bold tracking-[0.3em]">UNIVERSAL ENGINE</p>
        </div>

        {/* ููุฒุฉ ุฃูุงูุฑ ุงูุชุนุฏูู ุงูุฐูู (ูุง ูุจู ุงูุฑูุฏุฑ) */}
        <div className="flex flex-col gap-2">
          <label className="text-[10px] font-bold text-gray-500 uppercase">ูุงูุฐุฉ ุฃูุงูุฑ ุงูุฐูุงุก ุงูุงุตุทูุงุนู</label>
          <textarea 
            value={settings.prompt}
            onChange={(e) => setSettings({...settings, prompt: e.target.value})}
            placeholder="ุฃุถู ุฃูุงูุฑ ุฎุงุตุฉ: ูุซูุงู 'ุฃุถู ุฃุดุฌุงุฑุงู'ุ 'ุงุฌุนู ุงูุฌุฏุฑุงู ุฎุดุจูุฉ'..."
            className="w-full h-28 bg-[#05070a] border border-gray-800 rounded-xl p-3 text-xs focus:border-blue-500 outline-none transition-all"
          />
        </div>

        {/* ุงุณุชุฑุฌุงุน ุฃูุถุงุน ุงูุฅุถุงุกุฉ (HDRI) */}
        <div className="flex flex-col gap-2">
          <label className="text-[10px] font-bold text-gray-500 uppercase">ูุถุนูุฉ ุงูุฅุถุงุกุฉ ูุงูุจูุฆุฉ</label>
          <div className="grid grid-cols-2 gap-2">
            {HDRI_ENVIRONMENTS.map((env) => (
              <button
                key={env.id}
                onClick={() => setSettings({...settings, hdri: env.id})}
                className={`p-2 text-[10px] rounded-lg border transition-all ${settings.hdri === env.id ? 'border-blue-500 bg-blue-500/10 text-white' : 'border-gray-800 bg-[#161b22] text-gray-500'}`}
              >
                {env.label}
              </button>
            ))}
          </div>
        </div>

        {/* ููุงูุด ุงูุชุตุฑู ูุงูุงูุชุฒุงู */}
        <div className="p-4 bg-[#161b22] rounded-xl border border-gray-800">
          <label className="text-[10px] font-bold text-gray-500 block mb-2">ูุงูุด ุงูุชุตุฑู ุงูุฅุจุฏุงุนู</label>
          <input 
            type="range" 
            value={settings.creativity}
            onChange={(e) => setSettings({...settings, creativity: parseInt(e.target.value)})}
            className="w-full accent-blue-600" 
          />
          <div className="flex justify-between text-[9px] mt-1 italic">
            <span>ุฏูุฉ ูุนูุงุฑูุฉ</span>
            <span>ุฎูุงู ูุงุณุน</span>
          </div>
        </div>

        <button 
          onClick={startRender}
          className="w-full bg-blue-600 hover:bg-blue-500 text-white py-4 rounded-xl font-black shadow-xl active:scale-95 transition-all"
        >
          ุจุฏุก ุงูุฑูุฏุฑ ุงููุงูุนู
        </button>
      </aside>

      {/* 2. ููุทูุฉ ุงูุนูู: ูุธุงู ุงููุฑุจุนูู (Dual-Box) */}
      <main className="flex-1 grid grid-cols-2 gap-8 p-8 items-start">
        
        {/* ูุฑุจุน ุงูุงุณุชูุจุงู */}
        <div className="flex flex-col gap-3">
          <h3 className="text-xs font-bold text-gray-500">1. ุงุฑูุน ูุดุฑูุนู</h3>
          <div 
            onClick={() => document.getElementById('upload-ref')?.click()}
            className={`aspect-square rounded-[2.5rem] border-2 border-dashed flex items-center justify-center relative overflow-hidden transition-all ${sourceImage ? 'border-blue-500 border-solid' : 'border-gray-800 hover:border-gray-600 cursor-pointer'}`}
          >
            {!sourceImage ? (
              <div className="text-center opacity-30">
                <span className="text-4xl block mb-2">๐๏ธ</span>
                <p className="text-[10px] uppercase font-bold tracking-widest">Upload Project</p>
              </div>
            ) : (
              <img src={sourceImage} className="absolute inset-0 w-full h-full object-cover" alt="Source" />
            )}
            <input id="upload-ref" type="file" hidden onChange={handleFileUpload} />
          </div>
        </div>

        {/* ูุฑุจุน ุงููุนุงูุฌุฉ ูุงูุชุญููู */}
        <div className="flex flex-col gap-3">
          <h3 className="text-xs font-bold text-gray-500">2. ุงูุฑูุฏุฑ ุงููุนุงูุฌ</h3>
          <div className="aspect-square rounded-[2.5rem] border-2 border-gray-800 bg-[#0d1117] relative overflow-hidden flex items-center justify-center">
            {isRendering && (
              <div className="absolute inset-0 z-50 bg-black/80 flex flex-col items-center justify-center">
                <div className="w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mb-4"></div>
                <p className="text-[10px] font-black text-blue-500 tracking-[0.3em]">AI PROCESSING...</p>
              </div>
            )}
            
            {renderedImage ? (
              <>
                <img src={renderedImage} className="absolute inset-0 w-full h-full object-cover" alt="Rendered" />
                <div className="absolute inset-0 bg-red-500/10 pointer-events-none flex items-center justify-center">
                   <p className="rotate-[-15deg] text-red-600/20 text-3xl font-black">www.avantgardbuildings.com</p>
                </div>
              </>
            ) : (
              <p className="text-[10px] text-gray-800 font-bold uppercase tracking-widest">Final Output</p>
            )}
          </div>

          {/* ุฒุฑ ุงูุชุญููู */}
          {renderedImage && (
            <a 
              href={renderedImage} 
              download="avantgard-render.png"
              className="w-full bg-[#161b22] border border-gray-800 text-white text-center py-3 rounded-xl font-bold text-xs hover:bg-gray-800 transition-all"
            >
              ุชุญููู ุงูุฑูุฏุฑ (HD)
            </a>
          )}
        </div>
      </main>

    </div>
  );
}
