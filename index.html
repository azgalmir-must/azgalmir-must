import React, { useState, useRef } from 'react';

const HDRI_ENVIRONMENTS = [
  { id: 'urban', label: 'ğŸ™ï¸ Ù†Ù‡Ø§Ø±', prompt: 'urban city center' },
  { id: 'forest', label: 'ğŸŒ² Ø·Ø¨ÙŠØ¹Ø©', prompt: 'forest surroundings' },
  { id: 'interior', label: 'ğŸ  Ø¯Ø§Ø®Ù„ÙŠ', prompt: 'modern interior' },
  { id: 'sunset', label: 'ğŸŒ‡ ØºØ±ÙˆØ¨', prompt: 'sunset lighting' },
];

const ASPECT_RATIOS = {
  '1:1': 'aspect-square',
  '16:9': 'aspect-video',
  '4:3': 'aspect-[4/3]'
};

export default function AvantgardApp() {
  const [sourceImage, setSourceImage] = useState<string | null>(null);
  const [renderedImage, setRenderedImage] = useState<string | null>(null);
  const [isRendering, setIsRendering] = useState(false);
  const fileInputRef = useRef<HTMLInputElement>(null);

  const [settings, setSettings] = useState({
    prompt: '', 
    hdri: 'urban',
    ratio: '1:1' as keyof typeof ASPECT_RATIOS,
    creativity: 75
  });

  const handleFileUpload = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (en) => setSourceImage(en.target?.result as string);
      reader.readAsDataURL(file);
    }
  };

  const startRender = () => {
    if (!sourceImage) return alert("Ø§Ø±ÙØ¹ Ù…Ø´Ø±ÙˆØ¹Ùƒ Ø£ÙˆÙ„Ø§Ù‹");
    setIsRendering(true);
    setTimeout(() => {
      setRenderedImage(sourceImage);
      setIsRendering(false);
    }, 4000);
  };

  return (
    // Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: lg:flex-row ØªØ¹Ù†ÙŠ ÙÙŠ Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø© ÙŠÙƒÙˆÙ† Ø¬Ù†Ø¨Ø§Ù‹ Ø¥Ù„Ù‰ Ø¬Ù†Ø¨ØŒ ÙˆÙÙŠ Ø§Ù„Ù‡Ø§ØªÙ flex-col (Ø±Ø£Ø³ÙŠ)
    <div className="flex flex-col lg:flex-row h-screen bg-[#05070a] text-gray-300 overflow-hidden dir-rtl" dir="rtl">
      
      {/* Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©: ØªØªÙƒÙŠÙ Ù…Ø¹ Ø§Ù„Ù‡Ø§ØªÙ Ù„ØªØµØ¨Ø­ ÙÙŠ Ø§Ù„Ø£Ø³ÙÙ„ Ø£Ùˆ ØªØ®ØªÙÙŠ Ø®Ù„Ù Ø²Ø± */}
      <aside className="w-full lg:w-[380px] h-auto lg:h-screen border-b lg:border-l border-gray-800 bg-[#0d1117] p-5 flex flex-col gap-4 overflow-y-auto z-20">
        <div className="text-center pb-4 border-b border-gray-800">
          <h1 className="text-xl lg:text-2xl font-black text-white italic tracking-tighter uppercase">AVANTGARD AI</h1>
          <p className="text-[8px] lg:text-[9px] text-blue-500 font-bold tracking-[0.3em]">MOBILE & DESKTOP READY</p>
        </div>

        {/* Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ */}
        <div className="flex flex-col gap-1">
          <label className="text-[10px] font-bold text-gray-500 uppercase">ğŸª„ Ø£ÙˆØ§Ù…Ø± Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø°ÙƒÙŠ</label>
          <textarea 
            value={settings.prompt}
            onChange={(e) => setSettings({...settings, prompt: e.target.value})}
            placeholder="Ù…Ø«Ø§Ù„: Ø£Ø¶Ù Ø£Ø«Ø§Ø«Ø§Ù‹ Ù…ÙˆØ¯Ø±Ù†..."
            className="w-full h-20 lg:h-28 bg-[#05070a] border border-gray-800 rounded-xl p-3 text-xs focus:border-blue-500 outline-none transition-all"
          />
        </div>

        {/* Ø§Ù„Ø¥Ø¶Ø§Ø¡Ø© - ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø¹Ø±Ø¶ ÙÙŠ Ø§Ù„Ù‡Ø§ØªÙ */}
        <div className="flex flex-col gap-1">
          <label className="text-[10px] font-bold text-gray-500 uppercase">ÙˆØ¶Ø¹ÙŠØ© Ø§Ù„Ø¥Ø¶Ø§Ø¡Ø©</label>
          <div className="grid grid-cols-2 lg:grid-cols-2 gap-2">
            {HDRI_ENVIRONMENTS.map((env) => (
              <button
                key={env.id}
                onClick={() => setSettings({...settings, hdri: env.id})}
                className={`p-2 lg:p-3 text-[10px] font-bold rounded-xl border transition-all ${settings.hdri === env.id ? 'border-blue-500 bg-blue-500/10 text-white' : 'border-gray-800 bg-[#161b22] text-gray-500'}`}
              >
                {env.label}
              </button>
            ))}
          </div>
        </div>

        {/* Ù‡Ø§Ù…Ø´ Ø§Ù„Ø¥Ø¨Ø¯Ø§Ø¹ */}
        <div className="p-3 bg-[#161b22] rounded-xl border border-gray-800">
          <label className="text-[10px] font-bold text-gray-500 block mb-2 uppercase">Ù‡Ø§Ù…Ø´ Ø§Ù„Ø¥Ø¨Ø¯Ø§Ø¹</label>
          <input 
            type="range" 
            min="0" max="100"
            value={settings.creativity}
            onChange={(e) => setSettings({...settings, creativity: parseInt(e.target.value)})}
            className="w-full accent-blue-600 cursor-pointer" 
          />
        </div>

        {/* Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯ */}
        <div className="flex flex-col gap-1">
          <label className="text-[10px] font-bold text-gray-500 uppercase">Ø£Ø¨Ø¹Ø§Ø¯ Ø§Ù„ØµÙˆØ±Ø©</label>
          <div className="grid grid-cols-3 gap-2">
            {(Object.keys(ASPECT_RATIOS) as Array<keyof typeof ASPECT_RATIOS>).map((r) => (
              <button
                key={r}
                onClick={() => setSettings({...settings, ratio: r})}
                className={`p-2 text-[10px] font-bold rounded-lg border ${settings.ratio === r ? 'border-blue-500 bg-blue-500/10 text-white' : 'border-gray-800 bg-[#161b22]'}`}
              >
                {r}
              </button>
            ))}
          </div>
        </div>

        <button 
          onClick={startRender}
          className="w-full bg-blue-600 hover:bg-blue-500 text-white py-4 rounded-xl font-black text-xs shadow-xl active:scale-95 transition-all mt-2"
        >
          Ø¨Ø¯Ø¡ Ø§Ù„Ø±Ù†Ø¯Ø±
        </button>
      </aside>

      {/* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¹Ù…Ù„: ØªØªÙƒÙŠÙ Ù„ØªØµØ¨Ø­ ØªØ­Øª Ø¨Ø¹Ø¶Ù‡Ø§ ÙÙŠ Ø§Ù„Ù‡Ø§ØªÙ */}
      <main className="flex-1 overflow-y-auto p-4 lg:p-10">
        <div className="max-w-5xl mx-auto grid grid-cols-1 lg:grid-cols-2 gap-6 lg:gap-10">
          
          {/* Ø§Ù„Ù…Ø±Ø¨Ø¹ 1: Ø§Ù„Ø±ÙØ¹ */}
          <div className="flex flex-col gap-2">
            <h3 className="text-[10px] font-black text-gray-500 uppercase tracking-widest">1. Ø§Ø±ÙØ¹ Ù…Ø´Ø±ÙˆØ¹Ùƒ</h3>
            <div 
              onClick={() => fileInputRef.current?.click()}
              className={`relative rounded-3xl lg:rounded-[3rem] border-2 border-dashed flex items-center justify-center overflow-hidden transition-all duration-500 ${ASPECT_RATIOS[settings.ratio]} ${sourceImage ? 'border-blue-500 border-solid' : 'border-gray-800 bg-[#0d1117] cursor-pointer'}`}
            >
              {!sourceImage ? (
                <div className="text-center p-4">
                  <p className="text-[10px] font-black text-gray-600 uppercase">Ø§Ø¶ØºØ· Ù„Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©</p>
                </div>
              ) : (
                <img src={sourceImage} className="absolute inset-0 w-full h-full object-cover" alt="Source" />
              )}
              <input ref={fileInputRef} type="file" hidden onChange={handleFileUpload} />
            </div>
          </div>

          {/* Ø§Ù„Ù…Ø±Ø¨Ø¹ 2: Ø§Ù„Ø±Ù†Ø¯Ø± */}
          <div className="flex flex-col gap-2">
            <h3 className="text-[10px] font-black text-gray-500 uppercase tracking-widest">2. Ø§Ù„Ø±Ù†Ø¯Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</h3>
            <div className={`relative rounded-3xl lg:rounded-[3rem] border-2 border-gray-800 bg-[#0d1117] overflow-hidden flex items-center justify-center transition-all duration-500 ${ASPECT_RATIOS[settings.ratio]}`}>
              {isRendering && (
                <div className="absolute inset-0 z-50 bg-black/90 flex flex-col items-center justify-center">
                  <div className="w-10 h-10 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mb-4"></div>
                  <p className="text-[9px] font-black text-blue-500 tracking-[0.2em]">PROCESSING...</p>
                </div>
              )}
              
              {renderedImage ? (
                <>
                  <img src={renderedImage} className="absolute inset-0 w-full h-full object-cover" alt="Rendered" />
                  <div className="absolute inset-0 flex items-center justify-center opacity-20 pointer-events-none">
                    <p className="text-xs font-black text-red-600 rotate-[-15deg]">AVANTGARD WATERMARK</p>
                  </div>
                </>
              ) : (
                <p className="text-[10px] text-gray-800 font-bold uppercase tracking-widest">Output Window</p>
              )}
            </div>

            {renderedImage && !isRendering && (
              <a 
                href={renderedImage} 
                download="render.png"
                className="w-full bg-white text-black text-center py-3 rounded-xl font-black text-xs hover:bg-gray-200 mt-2 transition-all"
              >
                ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©
              </a>
            )}
          </div>

        </div>
      </main>

    </div>
  );
}
